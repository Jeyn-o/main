<html>
<head>
<script>
const api_url = 'https://api.torn.com/v2/faction/members?striptags=true&key=';
let apikey = '';
let lastCallTime = null;
let lastErrorCode = null;

let pollInterval = null;
let pollDelay = 1000; // default 1 second
let paused = false;
let lowLatency = false;


// Track previous state per user ID
const memberStates = {};

function submit_api() {
    apikey = document.getElementById('api').value.trim();
    if (!apikey) return;

    testApiKey();
}

function testApiKey() {
    fetch(api_url + apikey)
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                alert(data.error.error);
                return;
            }

            if (data.members) {
                document.getElementById('api_input').style.display = 'none';
                document.getElementById('log_output').style.display = '';

                startPolling();
            }
        })
        .catch(err => {
            alert('API request failed');
            console.error(err);
        });
}

function startPolling() {
    if (pollInterval) clearInterval(pollInterval);

    pollInterval = setInterval(() => {
        if (!paused) {
            fetchMembers();
        }
    }, pollDelay);
}

function toggleLowLatency() {
    lowLatency = document.getElementById('lowLatency').checked;

    pollDelay = lowLatency ? 2000 : 1000;
    startPolling(); // restart interval with new delay

    updateStatusDisplay(); // update timer color thresholds immediately
}

function fetchMembers() {
    fetch(api_url + apikey + '&timestamp=' + Math.floor(Date.now() / 1000))
        .then(res => res.json())
        .then(data => {
            // Handle API error
            if (data.error) {
                lastErrorCode = data.error.error;
                updateStatusDisplay();
                return;
            }

            // Successful response clears error
            lastErrorCode = null;
            lastCallTime = Date.now();
            updateStatusDisplay();

            if (!data.members) return;

            data.members.forEach(user => {
                const prevState = memberStates[user.id];
                const currentState = user.status.state;

                if (!prevState) {
                    memberStates[user.id] = currentState;
                    return;
                }

                if (prevState === 'Okay' && currentState === 'Hospital') {
                    logHospitalEvent(user);
                }

                memberStates[user.id] = currentState;
            });
        })
        .catch(err => {
            // Network or fetch failure
            lastErrorCode = 'NETWORK';
            updateStatusDisplay();
            console.error(err);
        });
}

function logHospitalEvent(user) {
    const output = document.getElementById('output');
    const container = document.createElement('div');

    const now = new Date();
	const hh = String(now.getUTCHours()).padStart(2, '0');
	const mm = String(now.getUTCMinutes()).padStart(2, '0');

	const timeSpan = document.createElement('span');
	timeSpan.textContent = `${hh}:${mm} - `;
    
    const idSpan = document.createElement('span');
    idSpan.textContent = `[${user.id}] `;

    const nameSpan = document.createElement('span');
	nameSpan.textContent = `${user.name}: `;
	nameSpan.classList.add('user-name');

    const descSpan = document.createElement('span');
    descSpan.textContent = `${user.status.description} - `;

    const detailsSpan = document.createElement('span');
    detailsSpan.textContent = user.status.details;

    container.appendChild(timeSpan);
    container.appendChild(idSpan);
    container.appendChild(nameSpan);
    container.appendChild(descSpan);
    container.appendChild(detailsSpan);

    output.prepend(container);
}

function togglePause() {
    paused = !paused;
    document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause';
    updateStatusDisplay();
}


function updateStatusDisplay() {
    const statusSpan = document.getElementById('statusDisplay');

    let greenThreshold, yellowThreshold, redThreshold;

if (paused) {
    statusSpan.style.backgroundColor = 'gray';
    return;
}

// Determine thresholds
if (lowLatency) {
    greenThreshold = 2000;
    yellowThreshold = 4000;
    redThreshold = 4000; // anything above yellow
} else {
    greenThreshold = 1000;
    yellowThreshold = 3000;
    redThreshold = 3000;
}

if (!lastCallTime) return;

const now = Date.now();
const diff = now - lastCallTime;

const d = new Date(lastCallTime);
const hh = String(d.getUTCHours()).padStart(2, '0');
const mm = String(d.getUTCMinutes()).padStart(2, '0');
const ss = String(d.getUTCSeconds()).padStart(2, '0');

let text = `Last call: ${hh}:${mm}:${ss}`;

if (lastErrorCode) {
    text += ` | Error: ${lastErrorCode}`;
}

statusSpan.textContent = text;

// Color logic
if (diff <= greenThreshold) {
    statusSpan.style.backgroundColor = 'green';
} else if (diff <= yellowThreshold) {
    statusSpan.style.backgroundColor = 'yellow';
} else {
    statusSpan.style.backgroundColor = 'red';
}

}

setInterval(updateStatusDisplay, 500);

</script>
<style>
/* Global styles */
body {
    background-color: #333;
    color: #ccc;
    font-size: 20px;
    font-family: Arial, sans-serif;
    margin: 20px;
}
a {
	color: #74c0fc;
}
a:hover {
	color: #a5d8ff;
}
a:visited {
    color: #74c0fc;
}


/* API input */
#api_input h4 {
    margin-bottom: 8px;
}

#api_input input {
    font-size: 18px;
    padding: 4px 8px;
}

/* Log output */
#log_output {
    margin-top: 20px;
}

/* Each log entry container */
#output > div {
    margin-bottom: 10px;
}

/* Highlight username */
.user-name {
    color: #74c0fc;
}

/* Pause button */
#pauseBtn {
    width: 80px;       /* fixed width for stability */
    text-align: center;
    padding: 4px 8px;
}

/* Status display */
#statusDisplay {
    padding: 4px 8px;
    margin-left: 8px;
    border-radius: 4px;
    font-family: monospace;
}
</style>
</head>
<body>
<div id="api_input">
<h4>Enter a <a title="To your API keys" href="https://www.torn.com/preferences.php#tab=api">limited API key</a>:</h4>
<input type="text" id="api"></input><button onclick="submit_api()">Submit</button><br>
<br>This script will make one API call every second or every other second, you can choose.<br>
<br>Torn allows 100 calls per minute, if you're using other services that make a lot of API calls, use low-latency mode.<br>
<br>Your key will not be stored. All data is visible to you only and will be gone when you refresh/close the page.<br>
<br>Depending on your browser settings, keeping this tab in the background might pause or slow your update rate.<br>
</div>
<div id="log_output" style="display:none">
<label>
  <input type="checkbox" id="lowLatency" onchange="toggleLowLatency()">
  Low-latency mode (2s)
</label>
<br>
<button id="pauseBtn" onclick="togglePause()">Pause</button>
<span id="statusDisplay">Last call: --:--</span>
<br>
<span id="output"></span>
</div>
</body>
</html>
