<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Armory Observer</title>
<style>
body { font-family: system-ui, sans-serif; margin:20px; }
h2 { margin-bottom:10px; }
details { margin-left:16px; }
summary { cursor:pointer; }
.former { color:#999; font-style:italic; }
.category { margin-top:6px; }
.item { margin-left:16px; }
.timestamp { margin-left:32px; color:#555; font-size:0.9em; }
.controls { margin-bottom:15px; }
button { margin-left:8px; }
.calendar-container { display:flex; gap:20px; margin-bottom:15px; }
.calendar { border:1px solid #ccc; padding:10px; }
.calendar-grid { display:grid; grid-template-columns: repeat(7,28px); gap:4px; }
.calendar-day { width:28px; height:28px; text-align:center; line-height:28px; border-radius:4px; user-select:none; }
.available { background-color:#e0ffe0; cursor:pointer; }
.unavailable { background-color:#f0f0f0; color:#aaa; cursor:default; }
.selected { background-color:#a0c4ff; }
.month-select, .year-select { margin-right:4px; }
.time-input { width:60px; margin-right:4px; }
</style>
</head>
<body>

<h2>Armory Observer</h2>

<div class="controls">
  <button id="toggleComparisonBtn">Toggle Comparison</button>
  <span id="selectedRangeText"></span>
  <button id="loadBtn">Load Selected</button>
</div>

<div style="margin-bottom:10px;">
  Start Time: <input type="time" id="startTimeInput" class="time-input" value="00:00">
  End Time: <input type="time" id="endTimeInput" class="time-input" value="23:59">
  <button id="clearTimeBtn">Clear Time</button>
</div>

<div id="mainCalendarContainer" class="calendar-container"></div>
<div id="comparisonCalendarContainer" class="calendar-container" style="display:none;"></div>

<hr>
<div id="output"></div>

<script>
/* ================= CONFIG ================= */
const LOG_BASE = "https://raw.githubusercontent.com/Jeyn-o/Armory_observer/main/logs";
const NAMES_URL = "https://raw.githubusercontent.com/Jeyn-o/OC_Stalker/refs/heads/main/BC_names.JSON";
const GH_API_BASE = "https://api.github.com/repos/Jeyn-o/Armory_observer/contents";

/* ================= STATE ================= */
let nameMap = {};
let mainCalendar = {startDate:null,endDate:null,month:0,year:0};
let comparisonCalendar = {startDate:null,endDate:null,month:0,year:0};
let availableDates = new Set();
let availableMonths = new Set();
let comparisonEnabled = false;

const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];

/* ================= HELPERS ================= */
function fmtTime(ts){
  const d=new Date(ts*1000);
  const hhmm=d.toISOString().slice(11,16);
  const ddmm=d.toISOString().slice(8,10)+"/"+d.toISOString().slice(5,7);
  return `${hhmm}<br>${ddmm}`;
}

function makeUTCDate(y,m,d,h=0,min=0){ return new Date(Date.UTC(y,m,d,h,min)); }
function mergeInto(target,data){
  for(const uid in data){
    target[uid] ??= {};
    for(const cat in data[uid]){
      target[uid][cat] ??= {};
      for(const item in data[uid][cat]){
        target[uid][cat][item] ??= [];
        target[uid][cat][item].push(...data[uid][cat][item]);
      }
    }
  }
}
function utcDateRange(from,to){
  const days=[]; const d=new Date(from);
  while(d<=to){ days.push(new Date(d)); d.setUTCDate(d.getUTCDate()+1); }
  return days;
}

/* ================= FETCH ================= */
async function loadNames(){
  nameMap = await fetch(NAMES_URL).then(r=>r.json());
}

async function loadLogs(from,to){
  const merged = {};
  const days = utcDateRange(from,to);
  const byMonth = {};
  for(const d of days){
    const y=d.getUTCFullYear();
    const m=String(d.getUTCMonth()+1).padStart(2,"0");
    const key = `${y}-${m}`;
    byMonth[key] ??= [];
    byMonth[key].push(d);
  }

  for(const monthKey in byMonth){
    const monthDays = byMonth[monthKey];
    const [y,m] = monthKey.split("-").map(Number);
    const daysInMonth = new Date(Date.UTC(y,m,0)).getUTCDate();
    const isFullMonth = monthDays.length===daysInMonth && monthDays[0].getUTCDate()===1;

    if(isFullMonth && availableMonths.has(monthKey)){
      const url = `${LOG_BASE}/${y}/${String(m).padStart(2,"0")}/Month.json`;
      try{
        const data = await fetch(url).then(r=>r.ok?r.json():null);
        if(data) mergeInto(merged,data);
        continue;
      }catch{}
    }

    for(const d of monthDays){
      const day = String(d.getUTCDate()).padStart(2,"0");
      const url = `${LOG_BASE}/${y}/${String(m).padStart(2,"0")}/${day}.json`;
      try{
        const data = await fetch(url).then(r=>r.ok?r.json():null);
        if(data) mergeInto(merged,data);
      }catch{}
    }
  }
  return merged;
}

/* ================= GITHUB DETECTION ================= */
async function fetchGitHubFolder(path){
  const res = await fetch(`${GH_API_BASE}/${path}`);
  if(!res.ok) throw new Error("GitHub fetch failed");
  return res.json();
}

async function detectAvailableDates(){
  const years = await fetchGitHubFolder("logs");
  for(const year of years){
    if(year.type!=="dir") continue;
    const months = await fetchGitHubFolder(`logs/${year.name}`);
    for(const month of months){
      if(month.type!=="dir") continue;
      const files = await fetchGitHubFolder(`logs/${year.name}/${month.name}`);
      for(const file of files){
        if(file.type!=="file"||!file.name.endsWith(".json")) continue;
        if(file.name==="Month.json") availableMonths.add(`${year.name}-${month.name}`);
        else{
          const day=file.name.replace(".json","");
          availableDates.add(`${year.name}-${month.name}-${day}`);
        }
      }
    }
  }
}

/* ================= RENDER ================= */
function render(data){
  const out=document.getElementById("output");
  out.innerHTML="";
  for(const uid in data){
    const names=nameMap[uid];
    const label=names?.[names.length-1]??uid;
    const userDetails=document.createElement("details");
    const userSummary=document.createElement("summary");
    userSummary.textContent=label;
    userDetails.appendChild(userSummary);
    for(const cat in data[uid]){
      const catDetails=document.createElement("details");
      catDetails.className="category";
      catDetails.innerHTML=`<summary>${cat}</summary>`;
      for(const item in data[uid][cat]){
        const entries=data[uid][cat][item];
        const total=entries.reduce((s,e)=>s+e[0],0);
        const itemDetails=document.createElement("details");
        itemDetails.className="item";
        itemDetails.innerHTML=`<summary>${item} (${total})</summary>`;
        entries.forEach(([amt,ts])=>{
          const div=document.createElement("div");
          div.className="timestamp";
          div.innerHTML=`${amt} Ã— ${fmtTime(ts)}`;
          itemDetails.appendChild(div);
        });
        catDetails.appendChild(itemDetails);
      }
      userDetails.appendChild(catDetails);
    }
    out.appendChild(userDetails);
  }
}

/* ================= CALENDAR ================= */
function createDualCalendar(container, state){
  container.innerHTML="";
  for(let i=0;i<2;i++){
    const calDiv=document.createElement("div");
    calDiv.className="calendar";
    const monthSel=document.createElement("select");
    monthSel.className="month-select";
    const yearSel=document.createElement("select");
    yearSel.className="year-select";
    calDiv.appendChild(monthSel); calDiv.appendChild(yearSel);
    const grid=document.createElement("div"); grid.className="calendar-grid";
    calDiv.appendChild(grid);
    container.appendChild(calDiv);

    // Fill year dropdown
    const years = Array.from(new Set([...availableDates].map(d=>d.split("-")[0]))).sort((a,b)=>b-a);
    yearSel.innerHTML="";
    years.forEach(y=>{
      const opt=document.createElement("option"); opt.value=y; opt.textContent=y; yearSel.appendChild(opt);
    });
    yearSel.value=state.year;
    // Fill month dropdown
    monthSel.innerHTML="";
    monthNames.forEach((name,idx)=>{
      const opt=document.createElement("option");
      opt.value=idx; opt.textContent=name;
      const monthKey=`${state.year}-${String(idx+1).padStart(2,"0")}`;
      if(!availableMonths.has(monthKey)) opt.disabled=true;
      monthSel.appendChild(opt);
    });
    monthSel.value=state.month;

    // Build grid
    buildCalendar(grid,state,Number(yearSel.value),Number(monthSel.value));

    monthSel.onchange=()=>buildCalendar(grid,state,Number(yearSel.value),Number(monthSel.value));
    yearSel.onchange=()=>{
      buildCalendar(grid,state,Number(yearSel.value),Number(monthSel.value));
      // Re-disable months based on new year
      Array.from(monthSel.options).forEach(opt=>{
        const monthKey=`${yearSel.value}-${String(Number(opt.value)+1).padStart(2,"0")}`;
        opt.disabled=!availableMonths.has(monthKey);
      });
    };
  }
}

function buildCalendar(grid,state,year,month){
  state.year=year; state.month=month;
  grid.innerHTML="";
  const firstDay=new Date(Date.UTC(year,month,1)).getUTCDay();
  const daysInMonth=new Date(Date.UTC(year,month+1,0)).getUTCDate();
  for(let i=0;i<firstDay;i++) grid.appendChild(document.createElement("div"));

  for(let d=1;d<=daysInMonth;d++){
    const div=document.createElement("div");
    div.textContent=d; div.className="calendar-day";
    const iso=`${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    if(availableDates.has(iso) || availableMonths.has(`${year}-${String(month+1).padStart(2,"0")}`)){
      div.classList.add("available");
      div.onclick=()=>{
        const clicked=makeUTCDate(year,month,d);
        if(!state.startDate || state.endDate){
          state.startDate=clicked; state.endDate=null;
        }else{
          if(clicked>=state.startDate) state.endDate=clicked;
          else { state.endDate=state.startDate; state.startDate=clicked; }
        }
        updateHighlight(grid,state);
        updateSelectedText();
      };
    } else div.classList.add("unavailable");
    grid.appendChild(div);
  }
  updateHighlight(grid,state);
}

function updateHighlight(grid,state){
  Array.from(grid.querySelectorAll(".calendar-day")).forEach(div=>div.classList.remove("selected"));
  if(!state.startDate) return;
  Array.from(grid.querySelectorAll(".calendar-day.available")).forEach(div=>{
    const day=Number(div.textContent);
    const date=makeUTCDate(state.year,state.month,day);
    if(state.endDate){
      if(date>=state.startDate && date<=state.endDate) div.classList.add("selected");
    }else if(date.getTime()===state.startDate.getTime()) div.classList.add("selected");
  });
}

function updateSelectedText(){
  const container=comparisonEnabled?comparisonCalendar:mainCalendar;
  if(!container.startDate){ selectedRangeText.textContent=""; return; }
  let txt=`Selected from: ${container.startDate.toUTCString()}`;
  if(container.endDate) txt+=` | Selected to: ${container.endDate.toUTCString()}`;
  selectedRangeText.textContent=txt;
}

/* ================= TIME HANDLERS ================= */
document.getElementById("clearTimeBtn").onclick=()=>{
  document.getElementById("startTimeInput").value="00:00";
  document.getElementById("endTimeInput").value="23:59";
};

/* ================= LOAD / COMPARE ================= */
document.getElementById("loadBtn").onclick=async()=>{
  const from=mainCalendar.startDate;
  const to=mainCalendar.endDate||mainCalendar.startDate;
  if(!from) return;
  if(comparisonEnabled){
    // TODO: gather comparison calendar range and call compare_data()
    compare_data(
      {start:from,end:to},
      {start:comparisonCalendar.startDate,end:comparisonCalendar.endDate||comparisonCalendar.startDate}
    );
  } else {
    console.log("Loading main calendar range:",from,to);
    const data=await loadLogs(from,to);
    render(data);
  }
};

/* ================= TOGGLE COMPARISON ================= */
document.getElementById("toggleComparisonBtn").onclick=()=>{
  comparisonEnabled=!comparisonEnabled;
  document.getElementById("comparisonCalendarContainer").style.display=comparisonEnabled?"flex":"none";
};

/* ================= INIT ================= */
(async()=>{
  await loadNames();
  await detectAvailableDates();
  const today=new Date();
  mainCalendar.month=today.getUTCMonth()-1; if(mainCalendar.month<0){mainCalendar.month=11; mainCalendar.year=today.getUTCFullYear()-1;} else mainCalendar.year=today.getUTCFullYear();
  comparisonCalendar.month=today.getUTCMonth(); comparisonCalendar.year=today.getUTCFullYear();
  createDualCalendar(document.getElementById("mainCalendarContainer"),mainCalendar);
  createDualCalendar(document.getElementById("comparisonCalendarContainer"),comparisonCalendar);
})();
</script>

</body>
</html>
