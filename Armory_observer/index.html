<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Armory Observer</title>

<style>
  body {
    font-family: system-ui, sans-serif;
    margin: 20px;
  }

  h2 {
    margin-bottom: 10px;
  }

  details {
    margin-left: 16px;
  }

  summary {
    cursor: pointer;
  }

  .former {
    color: #999;
    font-style: italic;
  }

  .category {
    margin-top: 6px;
  }

  .item {
    margin-left: 16px;
  }

  .timestamp {
    margin-left: 32px;
    color: #555;
    font-size: 0.9em;
  }

  .controls {
    margin-bottom: 15px;
  }

  button {
    margin-left: 8px;
  }
</style>
</head>
<body>

<h2>Armory Observer</h2>

<div class="controls">
  <label>
    From:
    <input type="date" id="fromDate">
  </label>
  <label>
    To:
    <input type="date" id="toDate">
  </label>
  <button id="loadBtn">Load</button>
</div>

<hr>

<div id="output"></div>

<script>
/* ================= CONFIG ================= */

const LOG_BASE =
  "https://raw.githubusercontent.com/Jeyn-o/Armory_observer/main/logs";

const NAMES_URL =
  "https://raw.githubusercontent.com/Jeyn-o/OC_Stalker/refs/heads/main/BC_names.JSON";

/* ================= STATE ================= */

let nameMap = {};

/* ================= HELPERS ================= */

function utcDateRange(from, to) {
  const days = [];
  const d = new Date(from);
  while (d <= to) {
    days.push(new Date(d));
    d.setUTCDate(d.getUTCDate() + 1);
  }
  return days;
}

function fmtTime(ts) {
  const d = new Date(ts * 1000);
  const hhmm = d.toISOString().slice(11, 16);
  const ddmm = d.toISOString().slice(8, 10) + "/" + d.toISOString().slice(5, 7);
  return `${hhmm}<br>${ddmm}`;
}

function getUserName(uid) {
  const names = nameMap[uid];
  if (!names || names.length === 0) {
    return { label: uid, former: false, tooltip: "" };
  }

  const last = names[names.length - 1];
  const isFormer = last === "Former Member";
  const label = isFormer
    ? names[names.length - 2] ?? uid
    : last;

  const tooltip =
    names.length > 1
      ? names.join(" → ")
      : "";

  return { label, former: isFormer, tooltip };
}

/* ================= FETCH ================= */

async function loadNames() {
  nameMap = await fetch(NAMES_URL).then(r => r.json());
}

async function loadLogs(from, to) {
  const merged = {};

  for (const d of utcDateRange(from, to)) {
    const y = d.getUTCFullYear();
    const m = String(d.getUTCMonth() + 1).padStart(2, "0");
    const day = String(d.getUTCDate()).padStart(2, "0");

    const url = `${LOG_BASE}/${y}/${m}/${day}.json`;

    try {
      const data = await fetch(url).then(r => {
        if (!r.ok) throw new Error("404");
        return r.json();
      });

      for (const uid in data) {
        merged[uid] ??= {};
        for (const cat in data[uid]) {
          merged[uid][cat] ??= {};
          for (const item in data[uid][cat]) {
            merged[uid][cat][item] ??= [];
            merged[uid][cat][item].push(...data[uid][cat][item]);
          }
        }
      }
    } catch {
      // missing day → ignore
    }
  }

  return merged;
}

/* ================= RENDER ================= */

function render(data) {
  const out = document.getElementById("output");
  out.innerHTML = "";

  for (const uid in data) {
    const name = getUserName(uid);

    const userDetails = document.createElement("details");
    const userSummary = document.createElement("summary");
    userSummary.textContent = name.label;
    if (name.former) userSummary.classList.add("former");
    if (name.tooltip) userSummary.title = name.tooltip;

    userDetails.appendChild(userSummary);

    for (const cat in data[uid]) {
      const catDetails = document.createElement("details");
      catDetails.className = "category";
      catDetails.innerHTML = `<summary>${cat}</summary>`;

      for (const item in data[uid][cat]) {
        const entries = data[uid][cat][item];
        const total = entries.reduce((s, e) => s + e[0], 0);

        const itemDetails = document.createElement("details");
        itemDetails.className = "item";
        itemDetails.innerHTML = `<summary>${item} (${total})</summary>`;

        entries.forEach(([amt, ts]) => {
          const div = document.createElement("div");
          div.className = "timestamp";
          div.innerHTML = `${amt} × ${fmtTime(ts)}`;
          itemDetails.appendChild(div);
        });

        catDetails.appendChild(itemDetails);
      }

      userDetails.appendChild(catDetails);
    }

    out.appendChild(userDetails);
  }
}

/* ================= BOOT ================= */

document.getElementById("loadBtn").onclick = async () => {
  const fromVal = document.getElementById("fromDate").value;
  const toVal = document.getElementById("toDate").value;
  if (!fromVal || !toVal) return;

  const from = new Date(fromVal);
  const to = new Date(toVal);

  const data = await loadLogs(from, to);
  render(data);
};

loadNames();
</script>

</body>
</html>
