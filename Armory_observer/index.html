<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Armory Observer</title>
<style>
body { font-family: system-ui, sans-serif; margin:20px; }
h2 { margin-bottom:10px; }
details { margin-left:16px; }
summary { cursor:pointer; }
.former { color:#999; font-style:italic; }
.category { margin-top:6px; }
.item { margin-left:16px; }
.timestamp { margin-left:32px; color:#555; font-size:0.9em; }
.controls { margin-bottom:15px; }
button { margin-left:8px; }
.calendar-day { width:28px; height:28px; text-align:center; line-height:28px; border-radius:4px; user-select:none; }
.available { background-color:#e0ffe0; cursor:pointer; }
.unavailable { background-color:#f0f0f0; color:#aaa; cursor:default; }
.calendar-container { display:flex; gap:20px; margin-bottom:10px; }
.time-inputs { margin-bottom:10px; }
</style>
</head>
<body>

<h2>Armory Observer</h2>

<div class="controls">
  <button id="openCalendarBtn">Select Dates</button>
  <span id="selectedRangeText"></span>
  <button id="loadBtn">Load Selected</button>
  <label><input type="checkbox" id="compareToggle"> Compare</label>
</div>

<div id="calendarPopup" style="display:none; position:absolute; border:1px solid #ccc; padding:10px; background:#fff; z-index:1000;">
  <div class="calendar-container">
    <div>
      <div style="display:flex; gap:5px; margin-bottom:5px;">
        <select id="monthSelect1"></select>
        <select id="yearSelect1"></select>
      </div>
      <div id="calendarGrid1" style="display:grid; grid-template-columns: repeat(7, 28px); gap:4px;"></div>
      <div class="time-inputs">
        Start: <input type="time" id="mainStartTime" value="00:00">
        End: <input type="time" id="mainEndTime" value="23:59">
      </div>
    </div>
    <div id="compareContainer" style="display:none;">
      <div style="display:flex; gap:5px; margin-bottom:5px;">
        <select id="monthSelect2"></select>
        <select id="yearSelect2"></select>
      </div>
      <div id="calendarGrid2" style="display:grid; grid-template-columns: repeat(7, 28px); gap:4px;"></div>
      <div class="time-inputs">
        Start: <input type="time" id="compStartTime" value="00:00">
        End: <input type="time" id="compEndTime" value="23:59">
      </div>
    </div>
  </div>
</div>

<hr>
<div id="output"></div>

<script>
/* ================= CONFIG ================= */
const LOG_BASE = "https://raw.githubusercontent.com/Jeyn-o/Armory_observer/main/logs";
const NAMES_URL = "https://raw.githubusercontent.com/Jeyn-o/OC_Stalker/refs/heads/main/BC_names.JSON";
const GH_API_BASE = "https://api.github.com/repos/Jeyn-o/Armory_observer/contents";

/* ================= STATE ================= */
let nameMap = {};
let startDate1=null, endDate1=null, startDate2=null, endDate2=null;
let currentYear1, currentMonth1, currentYear2, currentMonth2;

const availableDates = new Set();   // YYYY-MM-DD
const availableMonths = new Set();  // YYYY-MM

const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];

/* ================= HELPERS ================= */
function utcDateRange(from, to){
  const days=[]; const d=new Date(from);
  while(d<=to){ days.push(new Date(d)); d.setUTCDate(d.getUTCDate()+1); }
  return days;
}

function fmtTime(ts){
  const d=new Date(ts*1000);
  const hhmm=d.toISOString().slice(11,16);
  const ddmm=d.toISOString().slice(8,10)+"/"+d.toISOString().slice(5,7);
  return `${hhmm}<br>${ddmm}`;
}

function getUserName(uid){
  const names=nameMap[uid];
  if(!names||names.length===0) return {label:uid,former:false,tooltip:""};
  const last=names[names.length-1];
  const isFormer=last==="Former Member";
  const label=isFormer?names[names.length-2]??uid:last;
  const tooltip=names.length>1?names.join(" → "):"";
  return {label,former:isFormer,tooltip};
}

function makeUTCDate(y,m,d){ return new Date(Date.UTC(y,m,d)); }

function applyTime(date,timeStr){
    const [h,m] = timeStr.split(":").map(Number);
    const newDate = new Date(date);
    newDate.setUTCHours(h,m,0,0);
    return newDate;
}

/* ================= FETCH ================= */
async function loadNames(){
  nameMap = await fetch(NAMES_URL).then(r=>r.json());
}

function mergeInto(target, data){
  for(const uid in data){
    target[uid] ??= {};
    for(const cat in data[uid]){
      target[uid][cat] ??= {};
      for(const item in data[uid][cat]){
        target[uid][cat][item] ??= [];
        target[uid][cat][item].push(...data[uid][cat][item]);
      }
    }
  }
}

async function loadLogs(from, to){
  console.log("Loading main calendar range:", from, to);
  const merged = {};
  const days = utcDateRange(from,to);

  const byMonth={};
  for(const d of days){
    const y = d.getUTCFullYear();
    const m = String(d.getUTCMonth()+1).padStart(2,"0");
    const key = `${y}-${m}`;
    byMonth[key] ??= [];
    byMonth[key].push(d);
  }

  for(const monthKey in byMonth){
    const monthDays = byMonth[monthKey];
    const [y,m] = monthKey.split("-").map(Number);
    const daysInMonth = new Date(Date.UTC(y,m,0)).getUTCDate();
    const isFullMonth = monthDays.length===daysInMonth && monthDays[0].getUTCDate()===1;

    if(isFullMonth && availableMonths.has(monthKey)){
      const url = `${LOG_BASE}/${y}/${String(m).padStart(2,"0")}/Month.json`;
      try{
        const data = await fetch(url).then(r=>r.ok?r.json():null);
        if(data) mergeInto(merged,data);
        continue;
      }catch{}
    }
    for(const d of monthDays){
      const day = String(d.getUTCDate()).padStart(2,"0");
      const url = `${LOG_BASE}/${y}/${String(m).padStart(2,"0")}/${day}.json`;
      try{
        const data = await fetch(url).then(r=>r.ok?r.json():null);
        if(data) mergeInto(merged,data);
      }catch{}
    }
  }
  return merged;
}

/* ================= GITHUB DATE DETECTION ================= */
async function fetchGitHubFolder(path){
  const res = await fetch(`${GH_API_BASE}/${path}`);
  if(!res.ok) throw new Error("GitHub fetch failed");
  return res.json();
}

async function detectAvailableDates(){
  const years = await fetchGitHubFolder("logs");
  for(const year of years){
    if(year.type!=="dir") continue;
    const months = await fetchGitHubFolder(`logs/${year.name}`);
    for(const month of months){
      if(month.type!=="dir") continue;
      const files = await fetchGitHubFolder(`logs/${year.name}/${month.name}`);
      for(const file of files){
        if(file.type!=="file"||!file.name.endsWith(".json")) continue;
        if(file.name==="Month.json") availableMonths.add(`${year.name}-${month.name}`);
        else availableDates.add(`${year.name}-${month.name}-${file.name.replace(".json","")}`);
      }
    }
  }
}

/* ================= RENDER ================= */
function render(data){
  const out=document.getElementById("output");
  out.innerHTML="";
  for(const uid in data){
    const name=getUserName(uid);
    const userDetails=document.createElement("details");
    const userSummary=document.createElement("summary");
    userSummary.textContent=name.label;
    if(name.former) userSummary.classList.add("former");
    if(name.tooltip) userSummary.title=name.tooltip;
    userDetails.appendChild(userSummary);
    for(const cat in data[uid]){
      const catDetails=document.createElement("details");
      catDetails.className="category";
      catDetails.innerHTML=`<summary>${cat}</summary>`;
      for(const item in data[uid][cat]){
        const entries=data[uid][cat][item];
        const total=entries.reduce((s,e)=>s+e[0],0);
        const itemDetails=document.createElement("details");
        itemDetails.className="item";
        itemDetails.innerHTML=`<summary>${item} (${total})</summary>`;
        entries.forEach(([amt,ts])=>{
          const div=document.createElement("div");
          div.className="timestamp";
          div.innerHTML=`${amt} × ${fmtTime(ts)}`;
          itemDetails.appendChild(div);
        });
        catDetails.appendChild(itemDetails);
      }
      userDetails.appendChild(catDetails);
    }
    out.appendChild(userDetails);
  }
}

/* ================= CALENDAR LOGIC ================= */
function createCalendar(gridEl, monthSelect, yearSelect, startDate, endDate, calendarId){
  let currentYear = new Date().getUTCFullYear();
  let currentMonth = new Date().getUTCMonth();

  monthSelect.innerHTML="";
  monthNames.forEach((name,i)=>{
    const opt=document.createElement("option");
    opt.value=i; opt.textContent=name;
    monthSelect.appendChild(opt);
  });
  yearSelect.innerHTML="";
  const years=Array.from(new Set([...availableDates].map(d=>d.split("-")[0]))).sort((a,b)=>b-a);
  years.forEach(y=>{
    const opt=document.createElement("option");
    opt.value=y; opt.textContent=y;
    yearSelect.appendChild(opt);
  });
  yearSelect.value=years[0]||currentYear;
  monthSelect.value=currentMonth;

  function buildCalendar(){
    currentYear=Number(yearSelect.value); currentMonth=Number(monthSelect.value);
    gridEl.innerHTML="";
    const firstDay = new Date(Date.UTC(currentYear,currentMonth,1)).getUTCDay();
    const daysInMonth = new Date(Date.UTC(currentYear,currentMonth+1,0)).getUTCDate();
    for(let i=0;i<firstDay;i++) gridEl.appendChild(document.createElement("div"));
    for(let d=1;d<=daysInMonth;d++){
      const div=document.createElement("div");
      div.textContent=d; div.className="calendar-day";
      const iso=`${currentYear}-${String(currentMonth+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
      if(availableDates.has(iso)||availableMonths.has(`${currentYear}-${String(currentMonth+1).padStart(2,"0")}`)){
        div.classList.add("available");
        div.onclick=()=>{
          const clicked=makeUTCDate(currentYear,currentMonth,d);
          if(!startDate.value || endDate.value){ startDate.value=clicked; endDate.value=null; }
          else{
            if(clicked>=startDate.value) endDate.value=clicked;
            else { endDate.value=startDate.value; startDate.value=clicked; }
          }
          updateHighlight();
          console.log(calendarId,"selected:",startDate.value,endDate.value);
        };
      } else div.classList.add("unavailable");
      gridEl.appendChild(div);
    }
    updateHighlight();
  }
  function updateHighlight(){
    gridEl.querySelectorAll(".calendar-day").forEach(d=>d.style.backgroundColor="");
    if(!startDate.value) return;
    gridEl.querySelectorAll(".calendar-day.available").forEach(div=>{
      const day=Number(div.textContent);
      const date=makeUTCDate(currentYear,currentMonth,day);
      if(endDate.value){
        if(date>=startDate.value && date<=endDate.value) div.style.backgroundColor="#a0c4ff";
      } else {
        if(date.getTime()===startDate.value.getTime()) div.style.backgroundColor="#a0c4ff";
      }
    });
  }

  monthSelect.onchange=buildCalendar;
  yearSelect.onchange=buildCalendar;
  buildCalendar();
  return {buildCalendar,updateHighlight};
}

/* ================= INIT CALENDAR ================= */
const startDateObj1={value:null}, endDateObj1={value:null};
const startDateObj2={value:null}, endDateObj2={value:null};
let cal1, cal2;

function initCalendars(){
  cal1 = createCalendar(
    document.getElementById("calendarGrid1"),
    document.getElementById("monthSelect1"),
    document.getElementById("yearSelect1"),
    startDateObj1,endDateObj1,"Main"
  );
  cal2 = createCalendar(
    document.getElementById("calendarGrid2"),
    document.getElementById("monthSelect2"),
    document.getElementById("yearSelect2"),
    startDateObj2,endDateObj2,"Compare"
  );
}

/* ================= OPEN/CLOSE & TOGGLE ================= */
const calendarPopupEl=document.getElementById("calendarPopup");
document.getElementById("openCalendarBtn").onclick=()=>{
  calendarPopupEl.style.display="block";
  cal1.updateHighlight();
  cal2.updateHighlight();
};

document.getElementById("compareToggle").onchange=(e)=>{
  document.getElementById("compareContainer").style.display=e.target.checked?"block":"none";
};

/* ================= LOAD BUTTON ================= */
document.getElementById("loadBtn").onclick=async()=>{
  const mainStartTime = document.getElementById("mainStartTime").value;
  const mainEndTime = document.getElementById("mainEndTime").value;
  const compStartTime = document.getElementById("compStartTime").value;
  const compEndTime = document.getElementById("compEndTime").value;

  if(!startDateObj1.value) return alert("Select a range on main calendar.");

  const from1 = applyTime(startDateObj1.value, mainStartTime);
  const to1   = applyTime(endDateObj1.value||startDateObj1.value, mainEndTime);

  if(!document.getElementById("compareToggle").checked){
    const data = await loadLogs(from1,to1);
    render(data);
  } else {
    if(!startDateObj2.value) return alert("Select a range on comparison calendar.");
    const from2 = applyTime(startDateObj2.value, compStartTime);
    const to2   = applyTime(endDateObj2.value||startDateObj2.value, compEndTime);
    compare_data({from:from1,to:to1},{from:from2,to:to2});
  }
  console.log("Main calendar range:",from1,to1);
  if(startDateObj2.value) console.log("Compare calendar range:",from2,to2);
};

/* ================= STUB ================= */
function compare_data(range1,range2){
  console.log("Compare stub:",range1,range2);
}

/* ================= INIT ================= */
(async()=>{
  await loadNames();
  await detectAvailableDates();
  initCalendars();
})();
</script>
</body>
</html>
