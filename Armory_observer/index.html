<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Armory Observer</title>
<style>
body { font-family: system-ui, sans-serif; margin:20px; }
h2 { margin-bottom:10px; }
details { margin-left:16px; }
summary { cursor:pointer; }
.former { color:#999; font-style:italic; }
.category { margin-top:6px; }
.item { margin-left:16px; }
.timestamp { margin-left:32px; color:#555; font-size:0.9em; }
.controls { margin-bottom:15px; }
button { margin-left:8px; }
.calendar-day { width:28px; height:28px; text-align:center; line-height:28px; border-radius:4px; user-select:none; }
.available { background-color:#e0ffe0; cursor:pointer; }
.unavailable { background-color:#f0f0f0; color:#aaa; cursor:default; }
.calendar-grid { display:grid; grid-template-columns: repeat(7, 28px); gap:4px; margin-bottom:10px; }
input[type=time] { margin-left:6px; width:80px; }
</style>
</head>
<body>

<h2>Armory Observer</h2>

<div class="controls">
  <button id="openCalendarBtn">Select Dates</button>
  <label><input type="checkbox" id="enableCompare"> Enable Comparison Calendar</label>
  <span id="selectedRangeText"></span>
  <button id="loadBtn">Load Selected</button>
</div>

<div id="calendarPopup" style="display:none; position:absolute; border:1px solid #ccc; padding:10px; background:#fff; z-index:1000;">
  <div id="mainCalendar"></div>
  <div id="mainTimeSelectors">
    Start time: <input type="time" id="mainStartTime" value="00:00">
    End time: <input type="time" id="mainEndTime" value="23:59">
  </div>
  <div id="compareCalendarContainer" style="display:none; margin-top:15px;">
    <div id="compareCalendar"></div>
    <div id="compareTimeSelectors">
      Start time: <input type="time" id="compareStartTime" value="00:00">
      End time: <input type="time" id="compareEndTime" value="23:59">
    </div>
  </div>
</div>

<hr>
<div id="output"></div>

<script>
/* ================= CONFIG ================= */
const LOG_BASE = "https://raw.githubusercontent.com/Jeyn-o/Armory_observer/main/logs";
const NAMES_URL = "https://raw.githubusercontent.com/Jeyn-o/OC_Stalker/refs/heads/main/BC_names.JSON";
const GH_API_BASE = "https://api.github.com/repos/Jeyn-o/Armory_observer/contents";

/* ================= STATE ================= */
let nameMap = {};
const availableDates = new Set();
const availableMonths = new Set();
const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];

/* ================= HELPERS ================= */
function makeUTCDate(y,m,d){ return new Date(Date.UTC(y,m,d)); }
function fmtTime(ts){ const d=new Date(ts*1000); return `${d.toISOString().slice(11,16)}<br>${d.toISOString().slice(8,10)}/${d.toISOString().slice(5,7)}`; }
function utcDateRange(from, to){ const arr=[]; const d=new Date(from); while(d<=to){ arr.push(new Date(d)); d.setUTCDate(d.getUTCDate()+1); } return arr; }
function getUserName(uid){ const names=nameMap[uid]; if(!names||names.length===0) return {label:uid,former:false,tooltip:""}; const last=names[names.length-1]; const isFormer=last==="Former Member"; const label=isFormer?names[names.length-2]??uid:last; const tooltip=names.length>1?names.join(" → "):""; return {label,former:isFormer,tooltip}; }

/* ================= FETCH ================= */
async function loadNames(){ nameMap = await fetch(NAMES_URL).then(r=>r.json()); }
function mergeInto(target, data){ for(const uid in data){ target[uid]??={}; for(const cat in data[uid]){ target[uid][cat]??={}; for(const item in data[uid][cat]){ target[uid][cat][item]??=[]; target[uid][cat][item].push(...data[uid][cat][item]); }}}}

async function loadLogs(from, to){
  const merged={};
  const days = utcDateRange(from, to);
  const byMonth={};
  for(const d of days){
    const y=d.getUTCFullYear(); const m=String(d.getUTCMonth()+1).padStart(2,"0");
    const key = `${y}-${m}`; byMonth[key]??=[]; byMonth[key].push(d);
  }

  for(const monthKey in byMonth){
    const monthDays = byMonth[monthKey];
    const [y,m] = monthKey.split("-").map(Number);
    const daysInMonth = new Date(Date.UTC(y, m,0)).getUTCDate();
    const isFullMonth = monthDays.length===daysInMonth && monthDays[0].getUTCDate()===1;

    if(isFullMonth && availableMonths.has(monthKey)){
      const url = `${LOG_BASE}/${y}/${String(m).padStart(2,"0")}/Month.json`;
      try{ const data=await fetch(url).then(r=>r.ok?r.json():null); if(data) mergeInto(merged,data); continue;}catch{}
    }

    for(const d of monthDays){
      const day=String(d.getUTCDate()).padStart(2,"0");
      const url = `${LOG_BASE}/${y}/${String(m).padStart(2,"0")}/${day}.json`;
      try{ const data=await fetch(url).then(r=>r.ok?r.json():null); if(data) mergeInto(merged,data);}catch{}
    }
  }
  return merged;
}

/* ================= GITHUB DETECTION ================= */
async function fetchGitHubFolder(path){ const res=await fetch(`${GH_API_BASE}/${path}`); if(!res.ok) throw new Error("GitHub fetch failed"); return res.json(); }
async function detectAvailableDates(){
  const years = await fetchGitHubFolder("logs");
  for(const year of years){ if(year.type!=="dir") continue;
    const months = await fetchGitHubFolder(`logs/${year.name}`);
    for(const month of months){ if(month.type!=="dir") continue;
      const files = await fetchGitHubFolder(`logs/${year.name}/${month.name}`);
      for(const file of files){
        if(file.type!=="file"||!file.name.endsWith(".json")) continue;
        if(file.name==="Month.json") availableMonths.add(`${year.name}-${month.name}`);
        else { const day=file.name.replace(".json",""); availableDates.add(`${year.name}-${month.name}-${day}`);}
      }
    }
  }
}

/* ================= RENDER ================= */
function render(data){
  const out=document.getElementById("output"); out.innerHTML="";
  for(const uid in data){
    const name=getUserName(uid);
    const userDetails=document.createElement("details");
    const userSummary=document.createElement("summary"); userSummary.textContent=name.label;
    if(name.former) userSummary.classList.add("former"); if(name.tooltip) userSummary.title=name.tooltip;
    userDetails.appendChild(userSummary);

    for(const cat in data[uid]){
      const catDetails=document.createElement("details"); catDetails.className="category"; catDetails.innerHTML=`<summary>${cat}</summary>`;
      for(const item in data[uid][cat]){
        const entries=data[uid][cat][item]; const total=entries.reduce((s,e)=>s+e[0],0);
        const itemDetails=document.createElement("details"); itemDetails.className="item"; itemDetails.innerHTML=`<summary>${item} (${total})</summary>`;
        entries.forEach(([amt,ts])=>{ const div=document.createElement("div"); div.className="timestamp"; div.innerHTML=`${amt} × ${fmtTime(ts)}`; itemDetails.appendChild(div);});
        catDetails.appendChild(itemDetails);
      }
      userDetails.appendChild(catDetails);
    }
    out.appendChild(userDetails);
  }
}

/* ================= MULTI-CALENDAR ================= */
function createCalendar(container, prefix){
  container.innerHTML="";
  const monthSelect1=document.createElement("select"); const yearSelect1=document.createElement("select");
  const monthSelect2=document.createElement("select"); const yearSelect2=document.createElement("select");
  container.appendChild(monthSelect1); container.appendChild(yearSelect1);
  container.appendChild(monthSelect2); container.appendChild(yearSelect2);

  monthNames.forEach((name,i)=>{ 
    const opt1=document.createElement("option"); opt1.value=i; opt1.textContent=name; monthSelect1.appendChild(opt1);
    const opt2=document.createElement("option"); opt2.textContent=name; opt2.value=i; monthSelect2.appendChild(opt2);
  });

  const years = Array.from(new Set([...availableDates].map(d=>d.split("-")[0]))).sort((a,b)=>b-a);
  years.forEach(y=>{
    const opt1=document.createElement("option"); opt1.value=y; opt1.textContent=y; yearSelect1.appendChild(opt1);
    const opt2=document.createElement("option"); opt2.value=y; opt2.textContent=y; yearSelect2.appendChild(opt2);
  });

  const grid1=document.createElement("div"); grid1.className="calendar-grid";
  const grid2=document.createElement("div"); grid2.className="calendar-grid";
  container.appendChild(grid1); container.appendChild(grid2);

  // Local state
  let localStartDate = null; let localEndDate = null;

  function buildGrid(year, month, grid){
    grid.innerHTML="";
    const firstDay=new Date(Date.UTC(year,month,1)).getUTCDay();
    const daysInMonth=new Date(Date.UTC(year,month+1,0)).getUTCDate();
    for(let i=0;i<firstDay;i++) grid.appendChild(document.createElement("div"));
    for(let d=1; d<=daysInMonth; d++){
      const div=document.createElement("div"); div.textContent=d; div.className="calendar-day";
      const iso=`${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
      const monthKey=`${year}-${String(month+1).padStart(2,"0")}`;
      if(availableDates.has(iso) || availableMonths.has(monthKey)){
        div.classList.add("available");
        div.onclick=()=>{
          const clicked=makeUTCDate(year,month,d);
          console.log(`[${prefix}] Clicked`,clicked.toISOString());
          if(!localStartDate || localEndDate){ localStartDate=clicked; localEndDate=null; }
          else { if(clicked>=localStartDate) localEndDate=clicked; else{ localEndDate=localStartDate; localStartDate=clicked; } }
          updateCalendarHighlight(); updateSelectedText();
        };
      } else div.classList.add("unavailable");
      grid.appendChild(div);
    }
  }

  function updateCalendarHighlight(){
    console.log(`[${prefix}] updating highlight`);
    container.querySelectorAll(".calendar-day").forEach(d=>d.style.backgroundColor="");
    if(!localStartDate) return;
    container.querySelectorAll(".calendar-day.available").forEach(div=>{
      const day = Number(div.textContent);
      const gridIndex = div.parentNode === grid1 ? 1 : 2;
      const year = gridIndex===1?Number(yearSelect1.value):Number(yearSelect2.value);
      const month = gridIndex===1?Number(monthSelect1.value):Number(monthSelect2.value);
      const date = makeUTCDate(year,month,day);
      if(localEndDate){ if(date>=localStartDate && date<=localEndDate) div.style.backgroundColor="#a0c4ff";}
      else if(date.getTime()===localStartDate.getTime()) div.style.backgroundColor="#a0c4ff";
    });
  }

  function updateSelectedText(){
    if(!localStartDate){ console.log(`[${prefix}] no date selected`); return;}
    let txt=`[${prefix}] Selected from: ${String(localStartDate.getUTCDate()).padStart(2,"0")}.${String(localStartDate.getUTCMonth()+1).padStart(2,"0")}.${localStartDate.getUTCFullYear()}`;
    if(localEndDate) txt+=` | Selected to: ${String(localEndDate.getUTCDate()).padStart(2,"0")}.${String(localEndDate.getUTCMonth()+1).padStart(2,"0")}.${localEndDate.getUTCFullYear()}`;
    selectedRangeText.textContent=txt;
    console.log(`[${prefix}] range updated`);
  }

  monthSelect1.onchange = ()=>buildGrid(Number(yearSelect1.value),Number(monthSelect1.value),grid1);
  yearSelect1.onchange = ()=>buildGrid(Number(yearSelect1.value),Number(monthSelect1.value),grid1);
  monthSelect2.onchange = ()=>buildGrid(Number(yearSelect2.value),Number(monthSelect2.value),grid2);
  yearSelect2.onchange = ()=>buildGrid(Number(yearSelect2.value),Number(monthSelect2.value),grid2);

  monthSelect1.selectedIndex=0; yearSelect1.selectedIndex=0; monthSelect2.selectedIndex=1; yearSelect2.selectedIndex=0;
  buildGrid(Number(yearSelect1.value),Number(monthSelect1.value),grid1);
  buildGrid(Number(yearSelect2.value),Number(monthSelect2.value),grid2);

  return {
    grid1, grid2, updateCalendarHighlight, updateSelectedText,
    get localStartDate(){ return localStartDate; },
    get localEndDate(){ return localEndDate; }
  };
}

/* ================= INIT ================= */
let mainCalendar, compareCalendar;
(async()=>{
  await loadNames();
  await detectAvailableDates();
  mainCalendar = createCalendar(document.getElementById("mainCalendar"),"Main");
  compareCalendar = createCalendar(document.getElementById("compareCalendar"),"Compare");
})();

/* ================= COMPARISON TOGGLE ================= */
document.getElementById("enableCompare").onchange=(e)=>{
  document.getElementById("compareCalendarContainer").style.display = e.target.checked ? "block" : "none";
};

/* ================= LOAD BUTTON ================= */
document.getElementById("loadBtn").onclick=async()=>{
  const comparisonEnabled = document.getElementById("enableCompare").checked;
  const fromMain = mainCalendar.localStartDate;
  const toMain = mainCalendar.localEndDate || mainCalendar.localStartDate;
  const mainStartTime = document.getElementById("mainStartTime").value;
  const mainEndTime = document.getElementById("mainEndTime").value;

  if(!fromMain){ console.log("No main date selected"); return; }

  if(!comparisonEnabled){
    console.log("Loading main calendar range:", fromMain,toMain);
    const data = await loadLogs(fromMain,toMain);
    render(data);
  } else {
    const fromCompare = compareCalendar.localStartDate;
    const toCompare = compareCalendar.localEndDate || compareCalendar.localStartDate;
    const compareStartTime = document.getElementById("compareStartTime").value;
    const compareEndTime = document.getElementById("compareEndTime").value;

    if(!fromCompare){ console.log("No compare date selected"); return; }

    console.log("Running compare_data with ranges:");
    console.log("Main:", fromMain,toMain,"times",mainStartTime,mainEndTime);
    console.log("Compare:", fromCompare,toCompare,"times",compareStartTime,compareEndTime);
    compare_data({from:fromMain,to:toMain,startTime:mainStartTime,endTime:mainEndTime},
                 {from:fromCompare,to:toCompare,startTime:compareStartTime,endTime:compareEndTime});
  }
};

/* ================= COMPARE HANDLER PLACEHOLDER ================= */
function compare_data(range1,range2){
  console.log("compare_data() called",range1,range2);
  alert("compare_data() would process these two ranges. Check console for details.");
}

</script>
</body>
</html>
